<html>

<head>
  <!-- Bootstrap core CSS -->
  <link href="https://getbootstrap.com/docs/4.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles CSS -->
  <link href="https://getbootstrap.com/docs/4.1/examples/offcanvas/offcanvas.css" rel="stylesheet">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>ErlBus Chat</title>
  <script src="/assets/jquery.js"></script>
  <script type="text/javascript">
    var websocket;
    jQuery(document).ready(init);

    function init() {
      jQuery("#roomContainer").hide();
      jQuery("#alertContainer").hide();
      jQuery("#connectButton").hide();
      if (!("WebSocket" in window)) {
        showAlert('<span style="color: red;">Your Web Browser doesn\'t support Websockets!</span>');
      } else {
        jQuery("#connectButton").show();
      };
    };

    function connect() {
      wsHost = "ws://" + window.location.host + "/websocket";
      websocket = new WebSocket(wsHost);
      websocket.onopen = function (evt) { onOpen(evt) };
      websocket.onclose = function (evt) { onClose(evt) };
      websocket.onmessage = function (evt) { onMessage(evt) };
      websocket.onerror = function (evt) { onError(evt) };
    };

    function onOpen(evt) {
      username = jQuery("#username").val();
      jQuery("#textToSend").val(username);
      sendMessage();

      jQuery('#roomContainer').show();
      jQuery('#username-form').hide();
    };

    function onClose(evt) {
      jQuery('#roomContainer').hide();
      jQuery('#username-form').show();
      showAlert('<span style="color: red;">Websocket connection has been closed!</span>');
    };

    function forcedClose() {
      websocket.close();
      onClose('any');
    }

    function onMessage(evt) {
      showMessage(jQuery.parseJSON(evt.data));
    };

    function onError(evt) {
      showAlert('<span style="color: red;">ERROR: ' + evt.data + '</span>');
    };

    function sendMessage() {
      if (websocket.readyState == websocket.OPEN) {
        var message = jQuery("#textToSend").val();
        websocket.send(message);
        jQuery("#textToSend").val("");
      } else {
        showAlert('<span style="color: red;">ERROR: websocket is not ready</span>');
      };
    };

    function showMessage(data) {
      jQuery('#chatContainer').append('<div>' + data.sender + ' [IP: ' + data.host + '] -> ' + data.msg + '</div>');
    };

    function showAlert(txt) {
      jQuery("#alertContainer").html(
        `<div class='alert alert-warning alert-dismissible fade show' role='alert'>` +
          txt +
          `<button type='button' class='close' data-dismiss='alert' aria-label='Close'>
            <span aria-hidden='true'>&times;</span>
          </button>
        </div>`
      );
      jQuery("#alertContainer").show();
    }
  </script>
  <style>
    #chatContainer {
      background-color:lightgray;
      min-width: 300px;
      min-height: 200px;
    }
    .container {
      font-family: "Trebuchet MS", Helvetica, sans-serif;
    }
    #msg-form {
      padding-top: 5%;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 class="jumbotron lead"><strong>Chat Room</strong></h1>
    <div id="alertContainer"></div>

    <form id="username-form" onsubmit="connect(); return false;">
      Insert your username:<br>
      <input id="username" type="text" placeholder="username">
      <button type="submit" class="btn btn-primary">
        Join the Chat Room
      </button>
    </form>

    <div id="roomContainer">
      <div id="chatContainer"></div>
      <form onsubmit="sendMessage(); return false;" id="msg-form">
        <span>
          <small>Message:</small>
          <input id="textToSend" type="text" />
        </span>
        <span>
          <button type="submit" class="btn btn-primary">
            Send Message
          </button>
        </span>
      </form>
      <form onsubmit="forcedClose(); return false;">
          <span>
              <button type="submit" class="btn btn-danger">
                  Disconnect
                </button>
          </span>
        </form>

    </div>
  </div>
</body>

</html>